name: Manual Deploy to Hosting

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging
      channel:
        description: 'Firebase hosting channel (leave blank for default)'
        required: false
        type: string

env:
  FLUTTER_VERSION: '3.10.4'

jobs:
  manual-deploy:
    name: Deploy to ${{ inputs.environment }}
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: ${{ env.FLUTTER_VERSION }}
          channel: 'stable'
          cache: true

      - name: Get Flutter dependencies
        run: flutter pub get

      - name: Build Flutter Web
        run: flutter build web --release --dart-define=FLUTTER_WEB_USE_SKIA=true

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: '${{ secrets.GITHUB_TOKEN }}'
          firebaseServiceAccount: '${{ secrets.FIREBASE_SERVICE_ACCOUNT }}'
          projectId: 'starpage-ed409'
          channelId: ${{ inputs.channel || 'live' }}
          buildCommand: 'echo "Already built"'
          entryPoint: 'build/web'
        env:
          FIREBASE_CLI_EXPERIMENTS: webframeworks

      - name: Create Deployment Notification
        uses: actions/github-script@v7
        if: success()
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            github.rest.repos.createDeployment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              ref: context.ref,
              environment: '${{ inputs.environment }}',
              description: 'Manual deployment to ${{ inputs.environment }}',
              auto_merge: false,
              required_contexts: []
            })

      - name: Post Success Message
        if: success()
        run: |
          echo "‚úÖ Deployment successful!"
          echo "üåç Environment: ${{ inputs.environment }}"
          echo "üöÄ URL: https://starpage-ed409.web.app"
          echo "üë§ Deployed by: ${{ github.actor }}"
          echo "‚è∞ Time: $(date)"
